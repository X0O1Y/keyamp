#+title: Keymap
#+author: Egor Maltsev

Think efficient based on [[file:packages/keymap.el][keymap]] for Emacs Mac Port.

#+begin_src bash
# emacs-mac
brew tap railwaycat/emacsmacport
brew install emacs-mac --with-natural-title-bar
defaults write org.gnu.Emacs TransparentTitleBar DARK
defaults write org.gnu.Emacs HideDocumentIcon YES
#+end_src

Below features how to use it.

** Features
- Macbook efficient setup
- iOS setup
- [[https://github.com/philc/vimium][Vimium]] bindings
- More keyboards

* Macbook efficient setup

Thumb cluster for common keyboard, arrows on home row, number row by touch and more.

- [[file:karabiner/karabiner.json][Karabiner]] config file. Emacs mode integration via variable!
- [[http://www.keyboard-layout-editor.com/#/gists/106550cd49793787784ed1b9c9117c3d][Layout]] based on [[file:layouts/Engram.bundle][Engineer Engram]]:

[[screenshots/iso-keyboard.png]]

- Automatic Russian layout support for command bindings

- Hack „Äê[[http://xahlee.info/emacs/misc/xah-fly-keys_esc.html][Escape]]„Äë
Escape activates command mode in GUI and terminal. Escape activates command mode in minibuffer, second press quits minibuffer. Deactivates mark too.

#+begin_src elisp
;; 1. <escape> set to keymap-command-mode-activate in keymap-shared-map
;; 2. <escape> set to keymap-escape in keymap-command-map
;; 3. catched tty ESC translates to <escape>

(progn
  (defun keymap-escape ()
    "Hack escape."
    (interactive)
    (when (region-active-p)
      (deactivate-mark))
    (when (active-minibuffer-window)
      (abort-recursive-edit)))

  (define-key keymap-command-map (kbd "<escape>") 'keymap-escape))

(progn
  (defvar keymap-fast-keyseq-timeout 50)

  (defun keymap-tty-ESC-filter (map)
    (if (and (equal (this-single-command-keys) [?\e])
             (sit-for (/ keymap-fast-keyseq-timeout 1000.0)))
        [escape] map))

  (defun keymap-lookup-key (map key)
    (catch 'found
      (map-keymap (lambda (k b) (if (equal key k) (throw 'found b))) map)))

  (defun keymap-catch-tty-ESC ()
    "Setup key mappings of current terminal to turn a tty's ESC into
`escape'."
    (when (memq (terminal-live-p (frame-terminal)) '(t pc))
      (let ((esc-binding (keymap-lookup-key input-decode-map ?\e)))
        (define-key input-decode-map
          [?\e] `(menu-item "" ,esc-binding :filter keymap-tty-ESC-filter)))))

  (keymap-catch-tty-ESC)

  (define-key key-translation-map (kbd "ESC") (kbd "<escape>")))
#+end_src

[[file:screenshots/desktop.png][desktop]]

*** Titlebar
#+begin_src elisp
  (add-to-list 'default-frame-alist '(ns-transparent-titlebar . t))

  (when (display-graphic-p)
    (setq display-time-default-load-average nil
          battery-mode-line-format "%b%p%%   "
          display-time-format "%a %e %b %R"
          ns-use-proxy-icon nil
          frame-title-format
          (list
           ;; align rigth spacer
           (let ((xph "") (xcount 110))
             (dotimes (_ xcount) (setq xph (concat "	" xph))) xph)

           ;; new messages count
           '(:eval (if (and (fboundp 'mu4e--modeline-string)
                            (> (length (mu4e--modeline-string)) 1))
                       (concat (substring (mu4e--modeline-string) 0 2) "			")
                     "					"))

           ;; battery percentage and datetime
           'battery-mode-line-string
           'display-time-string
           "			"

           ;; mode indicator
           'mode-line-front-space
           ))
    (display-battery-mode 1)
    (display-time-mode    1))
#+end_src

*** Modeline on top
#+begin_src elisp
(setq-default mode-line-format nil
              header-line-format
              (list
               " "
               ;; mode indicator
               (when terminal-p 'mode-line-front-space)

               ;; buffer name
               '(:eval (propertize " %b"
                                   'face
                                   (if (buffer-modified-p)
                                       'font-lock-string-face
                                     'font-lock-builtin-face)
                                   'help-echo
                                   (buffer-file-name)))

               ;; branch
               '(:eval (when
                           (and vc-mode
                                (not (or (string-equal (substring vc-mode 5) "master")
                                         (string-equal (substring vc-mode 5) "main"))))
                         (list " @" (substring vc-mode 5))))

               ;; align right spacer
               '(:eval (propertize
                        " " 'display
                        `((space :align-to
                                 (- (+ right right-fringe right-margin)
                                    ,(+ (length (format-mode-line "%l:%c "))))
                                 ))))

               ;; position in buffer
               '(:eval (propertize "%l:%c "
                                   'face 'font-lock-builtin-face))))

#+end_src

* iOS setup

Emacs in pocket with unicode support. Use [[https://apps.apple.com/us/app/termius-terminal-ssh-client/id549039908][Termius]] client. Custom keyboard.

*** Custom virtual keyboard
- Engineer Engram and Russian layouts
  - App Store: [[https://apps.apple.com/us/app/xkeyboard-custom-keyboard/id1440245962][xKeyboard - Custom Keyboard]]
  - Layout file: [[file:layouts/engineer-engram.xkeyboard][engineer-engram.xkeyboard]]

*** Virtual keyboard add-on Termius
- „Äê‚Üë„Äë „Äê‚Üì„Äë „Äê‚Üê„Äë „Äê‚Üí„Äë „Äêtab„Äë „Äêdel„Äë „ÄêpgUp„Äë „ÄêpgDn„Äë

*** Preferences
- Set terminal and keyboard coding system to utf-8:
#+begin_src elisp
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
#+end_src

- Use [[https://github.com/justbur/emacs-which-key][which-key]] for binding completion

[[screenshots/virtual-keyboard.png]]

- Emacs in tmux over mosh - instant remote access
#+begin_src bash
  mosh-server new -s -c 256 -l LANG=en_US.UTF-8 -- tmux -u new -As0 'emacs'
#+end_src

- Emacs in [[https://ish.app/][iSH]] - offline local access on iOS from Termius

- Nord theme for Emacs and Termius. Works worthy for GUI and terminal.

- Color mode indicators
#+begin_src elisp
(defvar keymap-command-mode-indicator   "üü¢"
  "Character indicating command mode is active.")
(defvar keymap-insert-mode-indicator    "üü†"
  "Character indicating insert mode is active.")
(defvar keymap-repeat-command-indicator "üîµ"
  "Character indicating repeat command is active.")

(defun keymap-mode-indicator-update ()
  "Update mode indicator."
  (if (eq real-this-command 'repeat)
      (setq mode-line-front-space keymap-repeat-command-indicator)
    (progn
      (if keymap-insert-state-p
          (setq mode-line-front-space keymap-insert-mode-indicator)
        (setq mode-line-front-space keymap-command-mode-indicator)))))

(add-hook 'post-command-hook 'keymap-mode-indicator-update)
#+end_src

* Vimium bindings

- Complete config file: [[file:layouts/virtual-keyboard.png][vimium-options-engineer-engram.json]]

* More keyboards and options
- Kinesis Advantage2 [[http://www.keyboard-layout-editor.com/#/gists/6a1a62133ab9f741589bd556cb946792][layout]] and [[file:layouts/qwerty2.txt][config]]:

[[screenshots/advantage2.png]]

Highly recommend portable lightweight keyboard:
- [[https://www.aliexpress.com/i/32837821853.html][AVATTO A20 Portable Leather Folding Mini Bluetooth]] weight 139 g

- Engineer Engram layout
Toggle translate qwerty layout to engineer engram on Emacs level. Useful when engineer engram layout not available in a different way.

  #+begin_src elisp
  (toggle-qwerty-to-engineer-engram)
  #+end_src

[[screenshots/pocket.jpg]] [[screenshots/pocket-2.jpg]]

